<form class="{{cssClass}} scenario-sheet two-column-layout" autocomplete="off">
    <aside class="scenario-sidebar">
        <nav class="sheet-tabs vertical-tabs" data-group="primary">
            <a class="item" data-tab="setting">
                <i class="fas fa-cogs"></i>
                <span>設定</span>
            </a>
            <a class="item" data-tab="scenario-info">
                <i class="fas fa-scroll"></i>
                <span>シナリオ情報</span>
            </a>
            <a class="item" data-tab="scenes">
                <i class="fas fa-film"></i>
                <span>シーン</span>
            </a>
            <a class="item" data-tab="texts">
                <i class="fas fa-paragraph"></i>
                <span>テキスト</span>
            </a>
            <a class="item" data-tab="info">
                <i class="fas fa-info-circle"></i>
                <span>情報項目</span>
            </a>
        </nav>
    </aside>

    <section class="sheet-body">
        <div class="tab setting" data-group="primary" data-tab="setting">
            <div class="scenario-content">
                <div class="setup-controls">
                    <button type="button" class="tnx-button" data-action="launch-wizard">
                        <i class="fas fa-magic"></i> セットアップウィザードを起動
                    </button>
                </div>
                <fieldset class="tnx-fieldset">
                    <legend>関連カード設定</legend>
                    <div class="card-management-grid">
                        <div class="card-slot" data-drop-area="cardDeck">
                            <h3 class="slot-header">山札 (トランプ)</h3>
                            <div class="slot-body">
                                {{#if cardDeck}}
                                    <button type="button" class="tnx-linked-button" data-action="open-document" data-uuid="{{cardDeck.uuid}}">
                                        <img src="{{cardDeck.img}}" class="tnx-linked-button__icon"/>
                                        <span class="tnx-linked-button__label">{{cardDeck.name}}</span>
                                    </button>
                                {{else}}
                                    <div class="tnx-import-box tnx-import-box--dropzone" data-drop-area="cardDeck">
                                        <span>山札(Deck)をドロップ</span>
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                        <div class="card-slot" data-drop-area="discardPile">
                            <h3 class="slot-header">捨て札</h3>
                            <div class="slot-body">
                                {{#if discardPile}}
                                    <button type="button" class="tnx-linked-button" data-action="open-document" data-uuid="{{discardPile.uuid}}">
                                        <img src="{{discardPile.img}}" class="tnx-linked-button__icon"/>
                                        <span class="tnx-linked-button__label">{{discardPile.name}}</span>
                                    </button>
                                {{else}}
                                    <div class="tnx-import-box tnx-import-box--dropzone" data-drop-area="discardPile">
                                        <span>捨て札(Pile)をドロップ</span>
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                        <div class="card-slot" data-drop-area="neuroDeck">
                            <h3 class="slot-header">ニューロデッキ</h3>
                            <div class="slot-body">
                                {{#if neuroDeck}}
                                    <button type="button" class="tnx-linked-button" data-action="open-document" data-uuid="{{neuroDeck.uuid}}">
                                        <img src="{{neuroDeck.img}}" class="tnx-linked-button__icon"/>
                                        <span class="tnx-linked-button__label">{{neuroDeck.name}}</span>
                                    </button>
                                {{else}}
                                    <div class="tnx-import-box tnx-import-box--dropzone" data-drop-area="neuroDeck">
                                        <span>山札(Deck)をドロップ</span>
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                        <div class="card-slot" data-drop-area="scenePile">
                            <h3 class="slot-header">シーンカード</h3>
                            <div class="slot-body">
                                {{#if scenePile}}
                                    <button type="button" class="tnx-linked-button" data-action="open-document" data-uuid="{{scenePile.uuid}}">
                                        <img src="{{scenePile.img}}" class="tnx-linked-button__icon"/>
                                        <span class="tnx-linked-button__label">{{scenePile.name}}</span>
                                    </button>
                                {{else}}
                                    <div class="tnx-import-box tnx-import-box--dropzone" data-drop-area="scenePile">
                                        <span>捨て札(Pile)をドロップ</span>
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                        <div class="card-slot" data-drop-area="accessCardPile">
                            <h3 class="slot-header">アクセスカード置き場</h3>
                            <div class="slot-body">
                                {{#if accessCardPile}}
                                    <button type="button" class="tnx-linked-button" data-action="open-document" data-uuid="{{accessCardPile.uuid}}">
                                        <img src="{{accessCardPile.img}}" class="tnx-linked-button__icon"/>
                                        <span class="tnx-linked-button__label">{{accessCardPile.name}}</span>
                                    </button>
                                {{else}}
                                    <div class="tnx-import-box tnx-import-box--dropzone" data-drop-area="accessCardPile">
                                        <span>手札(hand)をドロップ</span>
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                        <div class="card-slot" data-drop-area="gmTrumpDiscard">
                            <h3 class="slot-header">RL切り札捨て場</h3>
                            <div class="slot-body">
                                {{#if gmTrumpDiscard}}
                                    <button type="button" class="tnx-linked-button" data-action="open-document" data-uuid="{{gmTrumpDiscard.uuid}}">
                                        <img src="{{gmTrumpDiscard.img}}" class="tnx-linked-button__icon"/>
                                        <span class="tnx-linked-button__label">{{gmTrumpDiscard.name}}</span>
                                    </button>
                                {{else}}
                                    <div class="tnx-import-box tnx-import-box--dropzone" data-drop-area="gmTrumpDiscard">
                                        <span>捨て札(Pile)をドロップ</span>
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="tnx-fieldset">
                    <legend>RL専用カードの設定</legend>
                    <div class="manual-text">
                        <p>RL専用の手札と切り札は、このシナリオシートではなく、あなた個人のユーザー設定に紐づけられます。</p>
                        <p>設定や確認を行うには、画面左下の入室者リストからご自身のユーザー名を右クリックし、「<b>ユーザー設定</b>」を開いてください。</p>
                        <p>また、プレイヤー用の手札と切り札はキャラクター作成と同時に作成されます。RL用の手札と同様に設定を完了させてください。なお、ログインしていないユーザーは入室者リストを一度クリックして展開することで表示されるようになります。</p>
                    </div>
                </fieldset>
                <fieldset class="tnx-fieldset">
                    <legend>管理アクション</legend>
                    <div class="scenario-actions" style="display: flex; flex-direction: column; gap: 10px; max-width: 300px;">
                        <button type="button" class="tnx-button" data-action="reset-access-cards">
                            <i class="fas fa-undo"></i> アクセスカードをリセットする
                        </button>
                        <p class="notes">
                            RL切り札捨て場の「切り札」をRLの切り札置き場に戻します。
                        </p>
                        <button type="button" class="tnx-button" data-action="deal-initial-hands">
                            <i class="fas fa-hand-holding"></i> 初期手札を配布
                        </button>
                        <p class="notes">
                            全てのPCの手札をリセットし、システム設定枚数のカードを山札から配布します。
                        </p>
                        <button type="button" class="tnx-button" data-action="deal-trump-from-neuro">
                            <i class="fas fa-star"></i> 切り札を配布
                        </button>
                        <p class="notes">
                            ニューロデッキからカードを1枚引き、選択したキャストの切り札として配布します。
                        </p>
                    </div>
                </fieldset>
            </div>
        </div>

        <div class="tab scenario-info" data-group="primary" data-tab="scenario-info">
            <div class="scenario-info-container">
                <div class="trailer-section">
                    <div class="info-header">
                        <h3>トレーラー</h3>
                        <button type="button" class="tnx-button small-button" data-action="send-trailer-to-chat">
                            <i class="fas fa-paper-plane"></i> チャットに送信
                        </button>
                    </div>
                    <textarea name="trailer" class="trailer-textarea" rows="8" placeholder="シナリオのトレーラーをここに入力...">{{trailer}}</textarea>
                </div>
                <div class="handouts-section">
                    <div class="info-header">
                        <h3>ハンドアウト</h3>
                        <button type="button" class="add-handout-button" data-action="add-handout" title="ハンドアウトを追加">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="handout-list">
                        {{#each handouts as |handout|}}
                        <div class="handout-item" data-id="{{handout.id}}">
                            <div class="handout-row handout-row--header">
                                <input type="text" name="pcName" class="handout-pc-name" value="{{handout.pcName}}" placeholder="PC名">
                                <input type="text" name="title" class="handout-title" value="{{handout.title}}" placeholder="ハンドアウトのタイトル">
                                <div class="handout-controls">
                                    <a class="handout-control" data-action="send-handout-to-chat" title="チャットに送信"><i class="fas fa-paper-plane"></i></a>
                                    <a class="handout-control" data-action="delete-handout" title="削除"><i class="fas fa-trash"></i></a>
                                </div>
                            </div>
                            <div class="handout-row handout-row--recommendations">
                                <div class="recommendation-field">
                                    <label>コネ</label>
                                    <input type="text" name="connections" value="{{handout.connections}}">
                                </div>
                                <div class="recommendation-field">
                                    <label>推奨スート</label>
                                    <input type="text" name="recommendedSuit" value="{{handout.recommendedSuit}}">
                                </div>
                                <div class="recommendation-field">
                                    <label>推奨スタイル</label>
                                    <input type="text" name="recommendedStyle" value="{{handout.recommendedStyle}}">
                                </div>
                            </div>
                            <div class="handout-row handout-row--content-label">
                                <label>ハンドアウト内容</label>
                            </div>
                            <div class="handout-row handout-row--content-area">
                                <textarea name="content" rows="6" placeholder="ハンドアウトの内容を入力...">{{handout.content}}</textarea>
                            </div>
                            <div class="handout-row handout-row--ps">
                                <label>PS</label>
                                <input type="text" name="ps" value="{{handout.ps}}" placeholder="このハンドアウトの目的などを記載...">
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>

        <div class="tab scenes" data-group="primary" data-tab="scenes">
            <div class="scenes-container">
                {{#each scenes as |phaseScenes phaseKey|}}
                <div class="phase-section">
                    <div class="phase-header">
                        <h3>{{localize (lookup ../phaseLabels phaseKey)}}</h3>
                    </div>
                    <div class="scene-table">
                        <div class="scene-table-header">
                            <div class="header-cell scene-number">No.</div>
                            <div class="header-cell scene-name">シーン名</div>
                            <div class="header-cell scene-player">シーンプレイヤー</div>
                            <div class="header-cell master-scene">MS</div>
                            <div class="header-cell scene-switch">切替</div>
                            <div class="header-cell scene-controls">
                                <button type="button" class="add-scene-button" data-action="add-scene" data-phase="{{phaseKey}}" title="このフェイズにシーンを追加">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="scene-table-body">
                            {{#each phaseScenes as |scene index|}}
                                <div class="scene-item" data-scene-id="{{scene.id}}" data-phase="{{phaseKey}}">
                                    <div class="scene-main-row">
                                        <div class="table-cell scene-number">
                                            <input type="text" name="number" value="{{scene.number}}"/>
                                        </div>
                                        <div class="table-cell scene-name">
                                            <input type="text" name="name" value="{{scene.name}}"/>
                                        </div>
                                        <div class="table-cell scene-player">
                                            <select name="player">
                                                <option value="">- 未選択 -</option>
                                                {{#each ../../castActors as |actor|}}
                                                    <option value="{{actor.name}}" {{#if (eq actor.name ../scene.player)}}selected{{/if}}>
                                                        {{actor.name}}
                                                    </option>
                                                {{/each}}
                                            </select>
                                        </div>
                                        <div class="table-cell master-scene">
                                            <input type="checkbox" name="isMasterScene" {{checked scene.isMasterScene}}/>
                                        </div>
                                        <div class="table-cell scene-switch">
                                            <a class="scene-control" data-action="switch-scene" title="このシーンに切り替え"><i class="fas fa-play-circle"></i></a>
                                        </div>
                                        <div class="table-cell scene-controls">
                                            <a class="scene-control" data-action="delete-scene" title="このシーンを削除"><i class="fas fa-trash"></i></a>
                                        </div>
                                    </div>
                                    <details class="scene-details-row">
                                        <summary>切り替えメッセージ</summary>
                                        <div class="message-preview">
                                            <textarea name="switchMessage" rows="3" placeholder="シーン切り替え時にチャットに投稿されるメッセージを入力...">{{scene.switchMessage}}</textarea>
                                        </div>
                                    </details>
                                </div>
                            {{/each}}
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>
        </div>

        <div class="tab texts" data-group="primary" data-tab="texts">
            <div class="texts-container">
                <div class="texts-header">
                    <h3>シナリオテキスト</h3>
                    <button type="button" class="add-text-button" data-action="add-text-item" title="テキスト項目を追加">
                        <i class="fas fa-plus"></i> テキストを追加
                    </button>
                </div>
                <div class="text-item-list">
                    {{#each scenarioTexts as |textItem|}}
                        <div class="text-item" data-id="{{textItem.id}}">
                            <div class="text-item-header">
                                <input type="text" name="title" value="{{textItem.title}}" placeholder="テキストのタイトル"/>
                                <div class="text-item-controls">
                                    <a class="text-control" data-action="send-text-to-chat" title="チャットに送信"><i class="fas fa-paper-plane"></i></a>
                                    <a class="text-control" data-action="delete-text-item" title="この項目を削除"><i class="fas fa-trash"></i></a>
                                </div>
                            </div>
                            <div class="text-item-body">
                                <textarea name="content" rows="5" placeholder="チャットに送信するテキストを入力...">{{textItem.content}}</textarea>
                            </div>
                        </div>
                    {{else}}
                        <div class="no-items-placeholder">
                            <p>テキスト項目がありません。「テキストを追加」ボタンから作成してください。</p>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>

        <div class="tab info" data-group="primary" data-tab="info">
            <div class="info-container">
                <div class="info-header">
                    <h3>情報項目</h3>
                    <button type="button" class="add-info-button" data-action="add-info-item" title="情報項目を追加">
                        <i class="fas fa-plus"></i> 情報を追加
                    </button>
                </div>
                <div class="info-item-list">
                    {{#each infoItems as |infoItem|}}
                        <div class="info-item" data-id="{{infoItem.id}}">
                            <div class="info-item-header">
                                <input type="text" name="title" value="{{infoItem.title}}" placeholder="情報名" data-info-id="{{infoItem.id}}"/>
                                <div class="info-item-controls">
                                    <label class="disclosure-toggle">
                                        <input type="checkbox" name="isPublic" {{checked infoItem.isPublic}} title="{{#if infoItem.isPublic}}公開中 (クリックで非公開に){{else}}非公開 (クリックで公開){{/if}}" data-info-id="{{infoItem.id}}">
                                        <i class="fas {{#if infoItem.isPublic}}fa-lock-open{{else}}fa-lock{{/if}}"></i>
                                    </label>
                                    <a class="info-control" data-action="send-info-to-chat" data-info-id="{{infoItem.id}}" title="公開済みの情報をチャットに送信" {{#unless infoItem.isPublic}}disabled{{/unless}}>
                                        <i class="fas fa-paper-plane"></i>
                                    </a>
                                    <a class="info-control" data-action="delete-info-item" data-info-id="{{infoItem.id}}" title="この項目を削除"><i class="fas fa-trash"></i></a>
                                </div>
                            </div>
                            <div class="info-item-body">
                                <div class="info-contents-list">
                                    {{#each infoItem.contents as |contentItem|}}
                                        <div class="info-content-block {{#if contentItem.isDisclosed}}disclosed{{/if}}" data-content-id="{{contentItem.id}}">
                                            <div class="content-header">
                                                <h4>情報の内容</h4>
                                                <div class="info-item-controls">
                                                    <label class="disclosure-toggle">
                                                        <input type="checkbox" name="isDisclosed" {{checked contentItem.isDisclosed}} title="{{#if contentItem.isDisclosed}}調査済み (クリックで未調査に){{else}}未調査 (クリックで調査済みに){{/if}}" data-info-id="{{infoItem.id}}" data-content-id="{{contentItem.id}}">
                                                        <i class="fas {{#if contentItem.isDisclosed}}fa-eye{{else}}fa-eye-slash{{/if}}"></i>
                                                    </label>
                                                    <a class="content-control" data-action="delete-info-content" data-info-id="{{infoItem.id}}" data-content-id="{{contentItem.id}}" title="この情報内容を削除"><i class="fas fa-trash"></i></a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="skill-checks-area">
                                            <div class="skill-checks-header">
                                                <h5>使用技能</h5>
                                                <a class="skill-control" data-action="add-skill-check" data-info-id="{{infoItem.id}}" data-content-id="{{contentItem.id}}" title="使用技能を追加"><i class="fas fa-plus"></i></a>
                                            </div>
                                            <div class="skill-check-list">
                                                {{#each contentItem.skills as |skillItem|}}
                                                <div class="skill-check-row" data-skill-id="{{skillItem.id}}">
                                                    <input type="text" name="name" class="skill-name" placeholder="技能名" value="{{skillItem.name}}" data-info-id="{{infoItem.id}}" data-content-id="{{contentItem.id}}" data-skill-id="{{skillItem.id}}">
                                                    <span class="tn-label">目標値:</span>
                                                    <input type="number" name="tn" class="skill-tn" placeholder="-" value="{{skillItem.tn}}" data-info-id="{{infoItem.id}}" data-content-id="{{contentItem.id}}" data-skill-id="{{skillItem.id}}">
                                                    <a class="skill-control delete" data-action="delete-skill-check" data-info-id="{{infoItem.id}}" data-content-id="{{contentItem.id}}" data-skill-id="{{skillItem.id}}" title="この技能を削除"><i class="fas fa-times"></i></a>
                                                </div>
                                                {{/each}}
                                            </div>
                                        </div>
                                        <textarea name="text" rows="4" placeholder="情報の内容（プレイヤーに公開されるテキスト）を入力..." data-info-id="{{infoItem.id}}" data-content-id="{{contentItem.id}}">{{contentItem.text}}</textarea>
                                    {{/each}}
                                </div>
                            </div>
                            <div class="add-content-button-wrapper">
                                <button type="button" class="tnx-button add-content-button" data-action="add-info-content" data-info-id="{{infoItem.id}}">
                                    <i class="fas fa-plus"></i> 情報の内容を追加
                                </button>
                            </div>
                        </div>
                    {{else}}
                        <div class="no-items-placeholder">
                            <p>情報項目がありません。「情報を追加」ボタンから作成してください。</p>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    </section>
</form>